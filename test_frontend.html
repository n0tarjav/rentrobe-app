<!DOCTYPE html>
<html>
<head>
    <title>Frontend Test</title>
</head>
<body>
    <h1>Frontend Authentication Test</h1>
    
    <div>
        <h2>Registration Test</h2>
        <form id="registerForm">
            <input type="text" id="name" placeholder="Name" value="Test User" required>
            <input type="email" id="email" placeholder="Email" value="testfrontend@example.com" required>
            <input type="password" id="password" placeholder="Password" value="password123" required>
            <input type="tel" id="phone" placeholder="Phone" value="+91 9876543210" required>
            <input type="text" id="city" placeholder="City" value="Mumbai" required>
            <button type="submit">Register</button>
        </form>
        <div id="registerResult"></div>
    </div>
    
    <div>
        <h2>Login Test</h2>
        <form id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email" value="testfrontend@example.com" required>
            <input type="password" id="loginPassword" placeholder="Password" value="password123" required>
            <button type="submit">Login</button>
        </form>
        <div id="loginResult"></div>
    </div>
    
    <div>
        <h2>Profile Test</h2>
        <button onclick="testProfile()">Check Profile</button>
        <div id="profileResult"></div>
    </div>
    
    <div>
        <h2>Current User</h2>
        <div id="currentUser"></div>
    </div>

    <script>
        let currentUser = null;
        
        // Load user from localStorage on page load
        function loadUserFromStorage() {
            const savedUser = localStorage.getItem('rentrobe_user');
            if (savedUser && savedUser !== 'undefined' && savedUser !== 'null') {
                try {
                    const user = JSON.parse(savedUser);
                    if (user && user.id && user.name && user.email) {
                        currentUser = user;
                        console.log('Loaded user from storage:', user);
                        updateCurrentUserDisplay();
                    } else {
                        console.log('Invalid user data in storage, clearing...');
                        localStorage.removeItem('rentrobe_user');
                        currentUser = null;
                    }
                } catch (error) {
                    console.error('Error parsing saved user:', error);
                    localStorage.removeItem('rentrobe_user');
                    currentUser = null;
                }
            } else {
                currentUser = null;
            }
        }
        
        function updateCurrentUserDisplay() {
            const div = document.getElementById('currentUser');
            if (currentUser) {
                div.innerHTML = `<p>Logged in as: ${currentUser.name} (${currentUser.email})</p>`;
            } else {
                div.innerHTML = '<p>Not logged in</p>';
            }
        }
        
        async function fetchCurrentUser() {
            try {
                console.log('Fetching current user from server...');
                const response = await fetch('/api/profile', { credentials: 'include' });
                console.log('Profile response status:', response.status);
                
                if (response.ok) {
                    const user = await response.json();
                    console.log('Profile response data:', user);
                    currentUser = user;
                    localStorage.setItem('rentrobe_user', JSON.stringify(currentUser));
                    updateCurrentUserDisplay();
                    return true;
                } else if (response.status === 401) {
                    console.log('Not authenticated');
                    currentUser = null;
                    localStorage.removeItem('rentrobe_user');
                    updateCurrentUserDisplay();
                    return false;
                } else {
                    console.log('Profile fetch failed:', response.status);
                    return false;
                }
            } catch (e) {
                console.error('Profile fetch error:', e);
                return false;
            }
        }
        
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                phone: document.getElementById('phone').value,
                city: document.getElementById('city').value
            };
            
            console.log('Registering user:', userData);
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData),
                    credentials: 'include'
                });
                
                console.log('Registration response status:', response.status);
                const data = await response.json();
                console.log('Registration response data:', data);
                
                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('rentrobe_user', JSON.stringify(currentUser));
                    updateCurrentUserDisplay();
                    document.getElementById('registerResult').innerHTML = '<p style="color: green;">Registration successful!</p>';
                } else {
                    document.getElementById('registerResult').innerHTML = `<p style="color: red;">Registration failed: ${data.error}</p>`;
                }
            } catch (error) {
                console.error('Registration error:', error);
                document.getElementById('registerResult').innerHTML = '<p style="color: red;">Registration error</p>';
            }
        });
        
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const loginData = {
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            };
            
            console.log('Logging in user:', loginData);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginData),
                    credentials: 'include'
                });
                
                console.log('Login response status:', response.status);
                const data = await response.json();
                console.log('Login response data:', data);
                
                if (response.ok) {
                    currentUser = data.user;
                    localStorage.setItem('rentrobe_user', JSON.stringify(currentUser));
                    updateCurrentUserDisplay();
                    document.getElementById('loginResult').innerHTML = '<p style="color: green;">Login successful!</p>';
                } else {
                    document.getElementById('loginResult').innerHTML = `<p style="color: red;">Login failed: ${data.error}</p>`;
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('loginResult').innerHTML = '<p style="color: red;">Login error</p>';
            }
        });
        
        async function testProfile() {
            console.log('Testing profile access...');
            const success = await fetchCurrentUser();
            if (success) {
                document.getElementById('profileResult').innerHTML = '<p style="color: green;">Profile access successful!</p>';
            } else {
                document.getElementById('profileResult').innerHTML = '<p style="color: red;">Profile access failed!</p>';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserFromStorage();
            updateCurrentUserDisplay();
            fetchCurrentUser().then(() => {
                updateCurrentUserDisplay();
            });
        });
    </script>
</body>
</html>

